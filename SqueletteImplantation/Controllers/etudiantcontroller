using System.Collections;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using SqueletteImplantation.DbEntities;
using SqueletteImplantation.DbEntities.DTOs;
using SqueletteImplantation.DbEntities.Models;

namespace SqueletteImplantation.Controllers
{
    public class EtudiantController : Controller
    {
        private readonly MaBd _maBd;

        public EtudiantController(MaBd maBd)
        {
            _maBd = maBd;
        }



        [HttpGet]
        [Route("api/Etudiant/annees")]
        public IEnumerable EtudiantAnnee()//retourne tout les etudiant de l annï¿½e en cours
        {
            var AnneeRecente = (from b in _maBd.Etudiant 
                                select b.Annee).Max();
            return from b in _maBd.Etudiant
                   join ent in _maBd.Entreprise on b.Id equals ent.Id//nouvelle ligne
                   where b.Annee.Contains(AnneeRecente.ToString())
                   select b;
        }


        [HttpGet]
        [Route("api/Etudiant/RechercheSansAnnee/{recherchetxtbox}")]
        public IEnumerable Recherche(string recherchetxtbox)
        {
            return from b in _maBd.Etudiant
                   join ent in _maBd.Entreprise on b.Id equals ent.Id//nouvelle ligne
                   where
                   b.Nom.Contains(recherchetxtbox) ||
                   b.Prenom.Contains(recherchetxtbox) ||
                   b.Profil.Contains(recherchetxtbox) 
                  
                   orderby b.Annee
                   select new
                   {
                       b.Nom,
                       b.Prenom,
                       b.Profil,
                       b.Annee,
                       ent.nomentreprise,//nouvelle ligne

                   };
        }




        [HttpGet]
        [Route("api/Etudiant/{annees}/{recherchetxtbox}")]
        public IEnumerable Recherche(string recherchetxtbox, string annees)
        {
            return from b in _maBd.Etudiant
                   join ent in _maBd.Entreprise on b.Id equals ent.Id//nouvelle ligne
                   where b.Annee.Contains(annees) && (
                   b.Nom.Contains(recherchetxtbox) ||
                   b.Prenom.Contains(recherchetxtbox) ||
                   b.Profil.Contains(recherchetxtbox))


                   orderby b.Annee
                   select new
                   {
                       b.Nom,
                       b.Prenom,
                       b.Profil,
                       b.Annee,
                       ent.nomentreprise,//nouvelle ligne

                   };
        }




        [HttpGet]
        [Route("api/Etudiant/RemplirCombo")]
        public IEnumerable ListeAnnees()
        {
            return (from b in _maBd.Etudiant
                    orderby b.Annee descending
                    select b.Annee).Distinct();
        }





























    }
}